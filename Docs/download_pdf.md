# 全ページPDF印刷（右上ダウンロードアイコン）設計書

## 目的
Vercel環境で確実に動作するよう、PDF生成方式をクライアント完結型に変更する。サーバー処理・Headlessブラウザ依存を完全に排除し、ワンクリックでPDFを取得できる体験を目指す。

## 想定ユーザー体験
- 右上のダウンロードアイコンをクリック
- 画面全体（ページ分割を含む）がPDF化される
- 生成中はローディングスピナーが表示され、UIが一時ロックされる
- 生成後、自動でダウンロードが開始される
- 失敗時はエラートーストが表示され、再試行できる

## 要件
### 機能要件
- 全ページをPDF化し、1ファイルとしてダウンロードできること
- 画面上に表示されている情報と同等のレイアウトで出力されること
- モバイルでも利用できること（画面サイズに応じたレイアウト）
- PDF生成中はローディング表示を出すこと

### 非機能要件
- PDF生成は5〜10秒以内を目標とする（ページ数に応じて変動）
- 生成失敗時は原因ログを残す（クライアント側）
- 権限のないデータはPDF出力しない
- ページ数が多い場合は処理が重くなる旨をUIで注意表示する
- モバイルは利用可能だが非推奨である旨を補足表示する

## アーキテクチャ（確定）
### 方式A': クライアント生成（ブラウザ）
#### 概要
- DOMをCanvas化し、PDFへ変換する
- 使用ライブラリ: html2canvas + jsPDF
- 100%ブラウザ実行（Vercel制約なし）

#### 利点
- サーバー不要
- 実装が比較的簡単
- Vercel環境で確実に動作

#### 欠点
- ページ数が多いとメモリ消費が大きい
- レイアウト崩れやフォント劣化が起きやすい
- 生成時間が長くなる

## 方式変更の結論
- 旧: 方式B（サーバー生成 / Playwright）
- 新: 方式A'（クライアント生成・確定採用）

## 削除する要素
- Headlessブラウザ（Playwright / Puppeteer）
- PDF生成API（`/api/export/pdf`）
- サーバー側PDF処理ロジック

## 詳細設計（方式A'）
### 1. UI設計
- 右上にダウンロードアイコン
- クリック時にローディングスピナーを表示
- UI操作を一時ロック
- 成功時: 自動ダウンロード
- 失敗時: トースト通知

### 2. PDF生成ロジック
- 対象DOM: スライド全体をラップする専用コンテナ（例: `#pdf-export-root`）
- 処理フロー
  1. 対象DOMを一時的に表示状態にする
  2. html2canvasでCanvas化
  3. Canvasをページサイズごとに分割
  4. jsPDFでPDFとして結合
  5. Blob生成 → ダウンロード

### 3. 改ページルール
- 前提: CSSの自動改ページは不完全
- 対応方針: スライド1枚 = PDF 1ページ
- 各スライドは固定高さ（A4比率）で設計
- `page-break`系CSSは使用しない
- JS側でページ分割制御

### 4. PDF仕様
- 用紙: A4
- 余白: 10mm
- ページ番号: フッターに表示
- ヘッダー: タイトル / 作成日

### 5. フォント・品質制約
- WebフォントはCanvas変換時に劣化する可能性あり
- 日本語フォントは特に崩れやすい
- 設計方針
  - 装飾は最小限
  - 背景色・画像多用は避ける
  - 印刷品質は「簡易出力」と割り切る

### 6. パフォーマンス制約
- 想定ページ数: 最大5〜10ページ程度
- ページ数超過時は重くなる旨をUIで注意表示
- モバイルは利用可能だが非推奨

### 7. エラーハンドリング
- 主な失敗要因: メモリ不足 / Canvas生成失敗
- try/catchで捕捉
- トーストで「PDF生成に失敗しました」を表示

## 実装イメージ
### クライアント
- ボタン押下でPDF生成を開始
- 生成したBlobをダウンロード

## 設計思想としての位置づけ
- 本方式は暫定・簡易エクスポート用途
- 高品質PDFや大量ページが必要になった場合は、外部PDF生成サービスや専用サーバーへ切り替え可能な設計とする

## 今後の検討
- ページ数が多い場合の分割出力
- PDF生成の非同期化（ジョブキュー）
- PDFテンプレートのカスタマイズ
